"use strict";(self["webpackChunkwisdom_park_visitor"]=self["webpackChunkwisdom_park_visitor"]||[]).push([[33],{7033:function(e,i,t){t.r(i),t.d(i,{default:function(){return c}});var s=function(){var e=this,i=e.$createElement,s=e._self._c||i;return s("div",{staticClass:"vip-appointment"},[s("van-sticky",{attrs:{"offset-top":1e-8}},[s("van-nav-bar",{attrs:{title:"贵宾预约","left-arrow":""},on:{"click-left":e.onClickLeft}})],1),s("div",{staticClass:"edit-form"},[s("div",{staticClass:"tag-title"},[e._v("拜访信息")]),s("van-form",{ref:"visitorInfo",attrs:{"show-error":!1,model:e.visitorInfo,readonly:e.params.disabled},on:{submit:e.handleSubmit}},[s("div",{staticClass:"visitor-info"},[s("van-field",{attrs:{name:"visitorReason",required:"",label:"拜访事由",maxlength:"50",placeholder:"请输入拜访事由",rules:[{required:!0,message:"请输入拜访事由"}]},model:{value:e.visitorInfo.visitorReason,callback:function(i){e.$set(e.visitorInfo,"visitorReason",i)},expression:"visitorInfo.visitorReason"}}),s("van-field",{attrs:{clickable:!e.params.disabled,readonly:"",name:"visitStartTime",required:"",label:"拜访开始",placeholder:"请选择开始时间",rules:[{required:!0,message:"请选择开始时间"}]},on:{click:function(i){e.params.disabled||(e.showPickerStart=!0)}},model:{value:e.visitorInfo.visitStartTime,callback:function(i){e.$set(e.visitorInfo,"visitStartTime",i)},expression:"visitorInfo.visitStartTime"}}),s("van-popup",{attrs:{position:"bottom"},model:{value:e.showPickerStart,callback:function(i){e.showPickerStart=i},expression:"showPickerStart"}},[s("van-datetime-picker",{attrs:{type:"datetime","min-date":e.disabledTime("startMin"),"max-date":e.disabledTime("startMax")},on:{confirm:e.onConfirmStart,cancel:function(i){e.showPickerStart=!1}}})],1),s("van-field",{attrs:{clickable:!e.params.disabled,readonly:"",required:"",name:"visitEndTime",label:"拜访结束",placeholder:"请选择结束时间",rules:[{required:!0,message:"请选择结束时间"}]},on:{click:function(i){e.params.disabled||(e.showPickerEnd=!0)}},model:{value:e.visitorInfo.visitEndTime,callback:function(i){e.$set(e.visitorInfo,"visitEndTime",i)},expression:"visitorInfo.visitEndTime"}}),s("van-popup",{attrs:{position:"bottom"},model:{value:e.showPickerEnd,callback:function(i){e.showPickerEnd=i},expression:"showPickerEnd"}},[s("van-datetime-picker",{attrs:{type:"datetime","min-date":e.disabledTime("endMin"),"max-date":e.disabledTime("endMax")},on:{confirm:e.onConfirmEnd,cancel:function(i){e.showPickerEnd=!1}}})],1),s("van-field",{attrs:{name:"visitorCompany",label:"所属单位",maxlength:"50",placeholder:"请填写访客所属单位"},model:{value:e.visitorInfo.visitorCompany,callback:function(i){e.$set(e.visitorInfo,"visitorCompany",i)},expression:"visitorInfo.visitorCompany"}})],1)]),s("div",{staticClass:"tag-title"},[e._v("访客信息")]),e._l(e.userList,(function(i,a){return s("van-swipe-cell",{key:a,scopedSlots:e._u([e.params.disabled?null:{key:"right",fn:function(){return[s("van-button",{attrs:{square:"",type:"danger",text:"删除"},on:{click:function(i){return e.onDetailSubmit("del",a)}}})]},proxy:!0}],null,!0)},[s("div",{staticClass:"\n          van-cell van-cell--clickable van-cell--center van-cell--borderless\n          van-contact-card van-contact-card--edit\n        ",on:{click:function(t){return e.handleEdit(i,a)}}},[s("van-image",{attrs:{round:"",fit:"cover",src:i.fileList&&i.fileList[0]&&i.fileList[0].content||t(2752),alt:"图片加载失败"}}),s("div",{staticClass:"\n            van-cell__value van-cell__value--alone\n            van-contact-card__value\n            title-primary\n          "},[s("div",[e._v(e._s(i.visitorName))]),s("div",[e._v(e._s(i.visitorPhoneNbr))])]),s("i",{staticClass:"van-icon van-icon-arrow van-cell__right-icon"})],1)])})),e.params.disabled?e._e():s("van-contact-card",{attrs:{"add-text":"新增访客"},on:{click:e.handleAddDetail}}),e.verifyTime()?s("div",{staticClass:"footer-btn"},[e.params.disabled?e._e():s("van-icon",{attrs:{name:"save iconfont","class-prefix":"icon",size:"50"},on:{click:function(i){return e.$refs.visitorInfo.submit()}}}),e.visitorInfoId&&this.userList.length>0?s("van-icon",{attrs:{name:"duanxin iconfont","class-prefix":"icon",size:"50"},on:{click:e.handleSMS}}):e._e(),e.visitorInfoId&&this.userList.length>0?s("van-icon",{attrs:{name:"lianjie iconfont","class-prefix":"icon",size:"50"},on:{click:e.copyLink}}):e._e()],1):e._e()],2),s("div",{directives:[{name:"show",rawName:"v-show",value:e.editState,expression:"editState"}],staticClass:"detail"},[s("van-sticky",{attrs:{"offset-top":1e-8}},[s("van-nav-bar",{attrs:{"right-text":e.params.disabled?"":"保存",title:"访客信息","left-arrow":""},on:{"click-left":e.onClickLeft,"click-right":function(i){return e.$refs.userInfo.submit()}}})],1),s("div",{staticClass:"edit-form"},[s("van-form",{ref:"userInfo",attrs:{"show-error":!1,model:e.userInfo,readonly:e.params.disabled},on:{submit:function(i){return e.onDetailSubmit(i)}}},[s("div",{staticClass:"visitor-info"},[s("van-field",{attrs:{name:"fileList",label:"人脸上传"},scopedSlots:e._u([{key:"input",fn:function(){return[s("van-uploader",{attrs:{readonly:e.params.disabled,deletable:!e.params.disabled,"before-read":e.beforeRead,accept:"image/jpeg,image/jpg,image/png","max-count":1},on:{delete:function(i){e.userInfo.picData=""}},model:{value:e.userInfo.fileList,callback:function(i){e.$set(e.userInfo,"fileList",i)},expression:"userInfo.fileList"}})]},proxy:!0}])}),s("van-field",{attrs:{placeholder:"请填写访客姓名",name:"visitorName",label:"访客姓名",required:"",maxlength:"8",rules:[{required:!0,message:"请填写访客姓名"}]},model:{value:e.userInfo.visitorName,callback:function(i){e.$set(e.userInfo,"visitorName",i)},expression:"userInfo.visitorName"}}),s("van-field",{attrs:{name:"visitorPhoneNbr",label:"手机号码",required:"",placeholder:"请填写访客手机号码",type:"tel",maxlength:"11",rules:[{required:!0,message:"请填写访客手机号码"},{pattern:/^(13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\d{8}$/,message:"请输入正确格式的手机号码"}]},model:{value:e.userInfo.visitorPhoneNbr,callback:function(i){e.$set(e.userInfo,"visitorPhoneNbr",i)},expression:"userInfo.visitorPhoneNbr"}}),s("van-field",{attrs:{clickable:!e.params.disabled,readonly:"",name:"voucherTypeName",label:"证件类型",placeholder:"请选择证件类型"},on:{click:function(i){e.params.disabled||(e.showPickerType=!0)}},model:{value:e.userInfo.voucherTypeName,callback:function(i){e.$set(e.userInfo,"voucherTypeName",i)},expression:"userInfo.voucherTypeName"}}),s("van-popup",{attrs:{position:"bottom"},model:{value:e.showPickerType,callback:function(i){e.showPickerType=i},expression:"showPickerType"}},[s("van-picker",{attrs:{title:"证件类型","show-toolbar":"",columns:e.showPickerTypeList.map((function(e){return e.dicDisplay}))},on:{cancel:function(i){e.showPickerType=!1},confirm:e.onConfirmType}})],1),s("van-field",{attrs:{readonly:"身份证"===e.userInfo.voucherTypeName||e.params.disabled,clickable:!e.params.disabled,name:"voucherCode",label:"证件号码",maxlength:"50",placeholder:"请填写访客证件号码"},on:{click:function(i){e.params.disabled||"身份证"!==e.userInfo.voucherTypeName||(e.numberShow=!0)}},model:{value:e.userInfo.voucherCode,callback:function(i){e.$set(e.userInfo,"voucherCode",i)},expression:"userInfo.voucherCode"}}),s("van-number-keyboard",{attrs:{show:e.numberShow,"extra-key":"X","close-button-text":"完成"},on:{blur:function(i){e.numberShow=!1},input:function(i){e.userInfo.voucherCode=e.userInfo.voucherCode+i},delete:function(i){e.userInfo.voucherCode=e.userInfo.voucherCode.substr(0,e.userInfo.voucherCode.length-1)}}}),s("van-field",{attrs:{name:"visitSex",label:"访客性别"},scopedSlots:e._u([{key:"input",fn:function(){return[s("van-radio-group",{attrs:{disabled:e.params.disabled,direction:"horizontal"},model:{value:e.userInfo.visitSex,callback:function(i){e.$set(e.userInfo,"visitSex",i)},expression:"userInfo.visitSex"}},e._l(e.visitSexList,(function(i){return s("van-radio",{key:i.dicValue,attrs:{name:i.dicValue}},[e._v(" "+e._s(i.dicDisplay)+" ")])})),1)]},proxy:!0}])}),s("van-field",{attrs:{maxlength:"8",label:"车牌号码",name:"plate",placeholder:"请填写车牌号码"},model:{value:e.userInfo.plate,callback:function(i){e.$set(e.userInfo,"plate",i)},expression:"userInfo.plate"}}),s("van-field",{attrs:{name:"carryArticle",label:"携带物品",maxlength:"100",placeholder:"请填写访客携带物品"},model:{value:e.userInfo.carryArticle,callback:function(i){e.$set(e.userInfo,"carryArticle",i)},expression:"userInfo.carryArticle"}}),s("van-field",{attrs:{name:"remark",label:"备注",rows:"2",autosize:"",type:"textarea","show-word-limit":"",maxlength:"100",placeholder:"请填写备注"},model:{value:e.userInfo.remark,callback:function(i){e.$set(e.userInfo,"remark",i)},expression:"userInfo.remark"}})],1)])],1)],1),s("div",{staticClass:"footer-placeholder"})],1)},a=[],o=t(2865),r=o.Z,n=t(1001),l=(0,n.Z)(r,s,a,!1,null,null,null),c=l.exports},2865:function(__unused_webpack_module,__webpack_exports__,__webpack_require__){var _api_visitor__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3581),vuex__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(629);__webpack_exports__["Z"]={name:"VIPappointment",data(){return{numberShow:!1,checkbox:!1,editState:!1,showPickerTypeList:[{dicDisplay:"身份证",dicValue:"1"},{dicDisplay:"香港身份证",dicValue:"2"},{dicDisplay:"澳门身份证",dicValue:"3"},{dicDisplay:"港澳通行证",dicValue:"4"},{dicDisplay:"台湾居民定居证",dicValue:"5"},{dicDisplay:"其他",dicValue:"6"}],visitSexList:[{dicDisplay:"男",dicValue:"0"},{dicDisplay:"女",dicValue:"1"}],showPickerType:!1,showPickerStart:!1,showPickerEnd:!1,token:"",visitorInfoId:"",visitorInfo:{},userList:[],userInfo:{fileList:[],visitorName:"",visitorPhoneNbr:"",voucherTypeName:"身份证",voucherCode:"",visitSex:"",carryArticle:"",plate:"",remark:""},params:{}}},methods:{verifyTime(){return!this.params.disabled||new Date<new Date(this.visitorInfo.visitEndTime)},async init(){if(this.params=this.$util.getRouteParams(this.$route),this.token=this.params.token,this.visitorInfoId=this.params.vipVisitId,this.visitorInfoId)(0,_api_visitor__WEBPACK_IMPORTED_MODULE_0__.W1)({visitorInfoId:this.visitorInfoId}).then((res=>{if(200===res.code){const data=res.data.row[0];this.visitorInfo={...data,visitStartTime:this.$util.format(new Date(data.visitStartTime.replace(/-/g,"/")),"yyyy-MM-dd hh:mm"),visitEndTime:this.$util.format(new Date(data.visitEndTime.replace(/-/g,"/")),"yyyy-MM-dd hh:mm")},this.token=res.data.token,this.userList=eval("("+data.visitorPersonArr+")").map((e=>({...e,fileList:e.picData?[{content:e.picData.replace(/ /g,"+")}]:[],voucherTypeName:String(this.showPickerTypeList.find((i=>e.voucherType==i.dicValue)).dicDisplay)})))}else this.$toast.fail({message:res.msg})}));else{let e=new Date;this.visitorInfo.visitStartTime=this.$util.format(e,"yyyy-MM-dd hh:mm"),this.visitorInfo.visitEndTime=this.$util.format(new Date(e.setHours(e.getHours()+2)),"yyyy-MM-dd hh:mm")}},onClickLeft(){this.editState?(this.userInfo={voucherTypeName:"身份证",voucherCode:""},this.editState=!1,this.$refs.userInfo.resetValidation()):this.$router.back(-1)},onConfirmStart(e){this.visitorInfo.visitStartTime=this.$util.format(e,"yyyy-MM-dd hh:mm"),this.showPickerStart=!1},onConfirmEnd(e){this.visitorInfo.visitEndTime=this.$util.format(e,"yyyy-MM-dd hh:mm"),this.showPickerEnd=!1},disabledTime(e){switch(e){case"startMin":return new Date;case"startMax":if(this.visitorInfo.visitEndTime)return new Date<new Date(this.visitorInfo.visitEndTime.replace(/-/g,"/"))?new Date(this.visitorInfo.visitEndTime.replace(/-/g,"/")):void 0;break;case"endMin":return this.visitorInfo.visitStartTime?new Date(this.visitorInfo.visitStartTime.replace(/-/g,"/")):void 0;case"endMax":return this.visitorInfo.visitStartTime?new Date(Date.parse(this.visitorInfo.visitStartTime.replace(/-/g,"/"))+864e5):void 0}},handleEdit(e,i){this.userInfo={...e,i:i},this.editState=!0},handleAddDetail(){this.$refs.visitorInfo.validate().then((()=>{this.editState=!0}))},async beforeRead(e){const i="image/jpeg"===e.type||"image/png"===e.type||"mage/jpg"===e.type;if(!i)return new Promise((e=>(this.$toast({message:"请选择 jpg, png 格式文件!"}),this.userInfo.picData="",e(new Error(!1)))));{const i=await this.$util.iosRotateImg(e);0==this.$util.isImgChekSize?this.userInfo.picData=i:1==this.$util.isImgChekSize?this.$toast.fail("您选择的相片小于25K，请重新选择相片！"):this.$toast.fail("您选择的相片超过了7500K，请重新选择相片！")}},onConfirmType(e){this.userInfo.voucherTypeName=e,this.userInfo.voucherCode="",this.showPickerType=!1},onDetailSubmit(e,i){const[t,s]=[this.userList,this.userInfo];"del"!==e?void 0!==s.i?t[s.i]=s:t.push(s):t.splice(i,1),"del"!==e&&this.onClickLeft()},handleSubmit(){if(0==this.userList.length)return void this.$toast({message:"请添加访客信息"});this.$toast.loading({duration:0,forbidClick:!0,message:"数据保存中..."});let e=null;e=this.visitorInfoId?_api_visitor__WEBPACK_IMPORTED_MODULE_0__.dW:_api_visitor__WEBPACK_IMPORTED_MODULE_0__.Ab,e({...this.headParams,visitorPersonArr:this.userList.map((e=>({...e,fileList:null,voucherType:String(this.showPickerTypeList.find((i=>e.voucherTypeName===i.dicDisplay)).dicValue)})))}).then((e=>{this.$toast.clear(),200===e.code?(this.visitorInfoId=e.data.id,this.token=e.data.token,this.$util.getRouteParams({name:this.$route.name,params:{vipVisitId:this.visitorInfoId,token:e.data.token}}),this.$toast.success({message:e.msg})):this.$toast.fail({message:e.msg})})).catch((()=>{this.$toast.clear()}))},async handleSMS(){const e=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),i=String(this.userList.map((e=>e.visitorPhoneNbr))),t=`sms:/open?addresses=${i}${e?"&":"?"}body=${this.link}`,s=document.createElement("a");s.style.display="none",s.href=t,document.body.appendChild(s),s.click(),URL.revokeObjectURL(s.href),document.body.removeChild(s)},async copyLink(){this.$copyText(this.link).then((()=>{this.$toast({message:"复制成功,请将链接发送给访客"})}),(()=>{this.$toast.fail("Can not copy")}))}},computed:{link(){return`您好，${this.myUserInfo.name} 邀请您于 ${this.visitorInfo.visitStartTime} 至 ${this.visitorInfo.visitEndTime} 来访，请点击链接获取通行码 \n${this.$util.QR_CODE_LINK_IP}/visitor/passCertificate?key=${this.token} \n如果上传人脸，可通过人脸识别进入。\n如果填写车牌，可通过车闸识别进入。`},headParams(){return{...this.visitorInfo,visitStartTime:this.visitorInfo.visitStartTime+":00",visitEndTime:this.visitorInfo.visitEndTime+":00",visitType:"1",visitorInfoId:this.visitorInfoId,sts:this.visitorInfoId,unitId:this.unitId,phoneNbr:this.myUserInfo.phoneNbr,name:this.myUserInfo.name,toOpenid:this.myUserInfo.openId}},...(0,vuex__WEBPACK_IMPORTED_MODULE_1__.rn)({myUserInfo:e=>e.user.userInfo,unitId:e=>e.user.unitId})},created(){this.init()},watch:{editState(e){document.body.style.overflowY=e?"hidden":"auto"}},beforeRouteLeave(e,i,t){this.$ls.remove(i.name),t()}}},2752:function(e,i,t){e.exports=t.p+"img/default-touxiang.0f5aba16.png"}}]);
//# sourceMappingURL=33.0cfcd974.js.map